<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>APersonalSite</title>
</head>

<body>
  <section class="section">
    <div class="container">
      
<h1 class="title">
  GoogleCTF 2024 DESFUNCTIONAL Writeup
</h1>
<p class="subtitle"><strong>2024-06-24</strong></p>
<p>I took a shot at GoogleCTF solo this year, with the goal of solving a flag and doing writeup. I've been a regular and have won prices at my university's CTF which ranges from beginner to intermediate challenges. I wanted to find a more advanced challenge around my skill level, not for prizes but more as a learning opportunity.</p>
<p>I've always been strong in cryptography so I focused on the DESFUNCTIONAL challenge.</p>
<h2 id="challenge-description">Challenge description</h2>
<blockquote>
<p>A newbie firend of mine was tring to implement a secure server
for DES encryption and decrpytion but there seem to be some errors
unexpectedly creeping in the key. It is getting frustrating, please help</p>
</blockquote>
<h2 id="chall-py-attachment">chall.py attachment</h2>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#999999;"># Copyright 2024 Google LLC
</span><span style="color:#999999;">#
</span><span style="color:#999999;"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span style="color:#999999;"># you may not use this file except in compliance with the License.
</span><span style="color:#999999;"># You may obtain a copy of the License at
</span><span style="color:#999999;">#
</span><span style="color:#999999;">#     https://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#999999;">#
</span><span style="color:#999999;"># Unless required by applicable law or agreed to in writing, software
</span><span style="color:#999999;"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span style="color:#999999;"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style="color:#999999;"># See the License for the specific language governing permissions and
</span><span style="color:#999999;"># limitations under the License.
</span><span>
</span><span style="color:#8959a8;">import </span><span>signal
</span><span style="color:#8959a8;">import </span><span>os
</span><span style="color:#8959a8;">import </span><span>random
</span><span style="color:#8959a8;">import </span><span>sys
</span><span style="color:#8959a8;">from </span><span>Crypto.Cipher </span><span style="color:#8959a8;">import </span><span style="color:#c82829;">DES3
</span><span>
</span><span>
</span><span style="color:#8959a8;">class </span><span style="color:#c99e00;">Desfunctional</span><span>:
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">__init__</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#c82829;">self</span><span>.key </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">os.</span><span style="color:#c82829;">urandom</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">24</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#c82829;">self</span><span>.iv </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">os.</span><span style="color:#c82829;">urandom</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">8</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#c82829;">self</span><span>.flipped_bits </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">set</span><span style="color:#4271ae;">(range(</span><span style="color:#f5871f;">0</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">192</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">8</span><span style="color:#4271ae;">))
</span><span>        </span><span style="color:#c82829;">self</span><span>.challenge </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">os.</span><span style="color:#c82829;">urandom</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">64</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#c82829;">self</span><span>.counter </span><span style="color:#3e999f;">= </span><span style="color:#f5871f;">128
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">get_flag</span><span>(</span><span style="color:#f5871f;">self</span><span>, </span><span style="color:#f5871f;">plain</span><span>):
</span><span>        </span><span style="color:#8959a8;">if </span><span>plain </span><span style="color:#3e999f;">== </span><span style="color:#c82829;">self</span><span>.challenge:
</span><span>            </span><span style="color:#8959a8;">with </span><span style="color:#4271ae;">open(</span><span style="color:#718c00;">&quot;flag.txt&quot;</span><span style="color:#4271ae;">, </span><span style="color:#718c00;">&quot;rb&quot;</span><span style="color:#4271ae;">) </span><span style="color:#8959a8;">as </span><span>f:
</span><span>                </span><span style="color:#c82829;">FLAG </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">f.</span><span style="color:#c82829;">read</span><span style="color:#4271ae;">()
</span><span>            </span><span style="color:#8959a8;">return </span><span style="color:#c82829;">FLAG
</span><span>        </span><span style="color:#8959a8;">raise </span><span style="color:#c99e00;">Exception</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;Not quite right&quot;</span><span style="color:#4271ae;">)
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">get_challenge</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        cipher </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">DES3.</span><span style="color:#c82829;">new</span><span style="color:#4271ae;">(</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.key, </span><span style="color:#f5871f;">mode</span><span style="color:#3e999f;">=</span><span style="color:#c82829;">DES3</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">MODE_CBC</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">iv</span><span style="color:#3e999f;">=</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.iv)
</span><span>        </span><span style="color:#8959a8;">return </span><span style="color:#4271ae;">cipher.</span><span style="color:#c82829;">encrypt</span><span style="color:#4271ae;">(</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.challenge)
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">corruption</span><span>(</span><span style="color:#f5871f;">self</span><span>):
</span><span>        </span><span style="color:#8959a8;">if </span><span style="color:#4271ae;">len(</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.flipped_bits) </span><span style="color:#3e999f;">== </span><span style="color:#f5871f;">192</span><span>:
</span><span>            </span><span style="color:#c82829;">self</span><span>.flipped_bits </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">set</span><span style="color:#4271ae;">(range(</span><span style="color:#f5871f;">0</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">192</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">8</span><span style="color:#4271ae;">))
</span><span>        remaining </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">list</span><span style="color:#4271ae;">(</span><span style="color:#c99e00;">set</span><span style="color:#4271ae;">(range(</span><span style="color:#f5871f;">192</span><span style="color:#4271ae;">)) </span><span style="color:#3e999f;">- </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.flipped_bits)
</span><span>        num_flips </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">random.</span><span style="color:#c82829;">randint</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">1</span><span style="color:#4271ae;">, len(remaining))
</span><span>        </span><span style="color:#c82829;">self</span><span>.flipped_bits </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.flipped_bits.</span><span style="color:#c82829;">union</span><span style="color:#4271ae;">(
</span><span style="color:#4271ae;">            random.</span><span style="color:#c82829;">choices</span><span style="color:#4271ae;">(remaining, </span><span style="color:#f5871f;">k</span><span style="color:#3e999f;">=</span><span style="color:#4271ae;">num_flips))
</span><span>        mask </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">int</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">to_bytes</span><span style="color:#4271ae;">(sum(</span><span style="color:#f5871f;">2</span><span style="color:#3e999f;">**</span><span style="color:#4271ae;">i </span><span style="color:#8959a8;">for </span><span style="color:#4271ae;">i </span><span style="color:#8959a8;">in </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.flipped_bits), </span><span style="color:#f5871f;">24</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#8959a8;">return </span><span style="color:#c99e00;">bytes</span><span style="color:#4271ae;">(i </span><span style="color:#3e999f;">^ </span><span style="color:#4271ae;">j </span><span style="color:#8959a8;">for </span><span style="color:#4271ae;">i, j </span><span style="color:#8959a8;">in </span><span style="color:#4271ae;">zip(</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.key, mask))
</span><span>
</span><span>    </span><span style="color:#8959a8;">def </span><span style="color:#4271ae;">decrypt</span><span>(</span><span style="color:#f5871f;">self</span><span>, </span><span style="color:#f5871f;">text</span><span>: </span><span style="color:#c99e00;">bytes</span><span>):
</span><span>        </span><span style="color:#c82829;">self</span><span>.counter </span><span style="color:#3e999f;">-= </span><span style="color:#f5871f;">1
</span><span>        </span><span style="color:#8959a8;">if </span><span style="color:#c82829;">self</span><span>.counter </span><span style="color:#3e999f;">&lt; </span><span style="color:#f5871f;">0</span><span>:
</span><span>            </span><span style="color:#8959a8;">raise </span><span style="color:#c99e00;">Exception</span><span style="color:#4271ae;">(</span><span style="color:#718c00;">&quot;Out of balance&quot;</span><span style="color:#4271ae;">)
</span><span>        key </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">corruption</span><span style="color:#4271ae;">()
</span><span>        </span><span style="color:#8959a8;">if </span><span style="color:#4271ae;">len(text) </span><span style="color:#3e999f;">% </span><span style="color:#f5871f;">8 </span><span style="color:#3e999f;">!= </span><span style="color:#f5871f;">0</span><span>:
</span><span>            </span><span style="color:#8959a8;">return b</span><span style="color:#718c00;">&#39;&#39;
</span><span>        cipher </span><span style="color:#3e999f;">= </span><span style="color:#4271ae;">DES3.</span><span style="color:#c82829;">new</span><span style="color:#4271ae;">(key, </span><span style="color:#f5871f;">mode</span><span style="color:#3e999f;">=</span><span style="color:#c82829;">DES3</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">MODE_CBC</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">iv</span><span style="color:#3e999f;">=</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.iv)
</span><span>        </span><span style="color:#8959a8;">return </span><span style="color:#4271ae;">cipher.</span><span style="color:#c82829;">decrypt</span><span style="color:#4271ae;">(text)
</span><span>
</span><span>
</span><span style="color:#8959a8;">if </span><span>__name__ </span><span style="color:#3e999f;">== </span><span style="color:#718c00;">&quot;__main__&quot;</span><span>:
</span><span>    chall </span><span style="color:#3e999f;">= </span><span style="color:#c82829;">Desfunctional</span><span style="color:#4271ae;">()
</span><span>    </span><span style="color:#c82829;">PROMPT </span><span style="color:#3e999f;">= </span><span>(</span><span style="color:#718c00;">&quot;Choose an API option</span><span style="color:#f5871f;">\n</span><span style="color:#718c00;">&quot;
</span><span>              </span><span style="color:#718c00;">&quot;1. Get challenge</span><span style="color:#f5871f;">\n</span><span style="color:#718c00;">&quot;
</span><span>              </span><span style="color:#718c00;">&quot;2. Decrypt</span><span style="color:#f5871f;">\n</span><span style="color:#718c00;">&quot;
</span><span>              </span><span style="color:#718c00;">&quot;3. Get the flag</span><span style="color:#f5871f;">\n</span><span style="color:#718c00;">&quot;</span><span>)
</span><span>    </span><span style="color:#4271ae;">signal.</span><span style="color:#c82829;">alarm</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">128</span><span style="color:#4271ae;">)
</span><span>    </span><span style="color:#8959a8;">while </span><span style="color:#f5871f;">True</span><span>:
</span><span>        </span><span style="color:#8959a8;">try</span><span>:
</span><span>            option </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">int</span><span style="color:#4271ae;">(input(</span><span style="color:#c82829;">PROMPT</span><span style="color:#4271ae;">))
</span><span>            </span><span style="color:#8959a8;">if </span><span>option </span><span style="color:#3e999f;">== </span><span style="color:#f5871f;">1</span><span>:
</span><span>                </span><span style="color:#4271ae;">print(chall.</span><span style="color:#c82829;">get_challenge</span><span style="color:#4271ae;">().</span><span style="color:#c82829;">hex</span><span style="color:#4271ae;">())
</span><span>            </span><span style="color:#8959a8;">elif </span><span>option </span><span style="color:#3e999f;">== </span><span style="color:#f5871f;">2</span><span>:
</span><span>                ct </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">bytes</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">fromhex</span><span style="color:#4271ae;">(input(</span><span style="color:#718c00;">&quot;(hex) ct: &quot;</span><span style="color:#4271ae;">))
</span><span>                </span><span style="color:#4271ae;">print(chall.</span><span style="color:#c82829;">decrypt</span><span style="color:#4271ae;">(ct).</span><span style="color:#c82829;">hex</span><span style="color:#4271ae;">())
</span><span>            </span><span style="color:#8959a8;">elif </span><span>option </span><span style="color:#3e999f;">== </span><span style="color:#f5871f;">3</span><span>:
</span><span>                pt </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">bytes</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">fromhex</span><span style="color:#4271ae;">(input(</span><span style="color:#718c00;">&quot;(hex) pt: &quot;</span><span style="color:#4271ae;">))
</span><span>                </span><span style="color:#4271ae;">print(chall.</span><span style="color:#c82829;">get_flag</span><span style="color:#4271ae;">(pt))
</span><span>                </span><span style="color:#4271ae;">sys.</span><span style="color:#c82829;">exit</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">0</span><span style="color:#4271ae;">)
</span><span>        </span><span style="color:#8959a8;">except </span><span style="color:#c99e00;">Exception </span><span style="color:#8959a8;">as </span><span>e:
</span><span>            </span><span style="color:#4271ae;">print(e)
</span><span>            </span><span style="color:#4271ae;">sys.</span><span style="color:#c82829;">exit</span><span style="color:#4271ae;">(</span><span style="color:#f5871f;">1</span><span style="color:#4271ae;">)
</span><span>
</span></code></pre>
<h2 id="understanding-the-script">Understanding the script</h2>
<p>The script takes input for three options:</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span></code></pre>
<p>Lets work backwards.</p>
<p>Our flag is read by option 3 <code>get_flag(self, plain)</code>.</p>
<p><code>if plain == self.challenge</code> the flag is read.</p>
<p><code>self.challenge = os.urandom(64)</code> is a random 64 bytes. We'll need to determine the value of the challenge plaintext to retrieve the flag.</p>
<p>Option 1 <code>get_challenge(self)</code> returns the ciphertext of <code>challenge</code> encrypted with 3DES.</p>
<p>Option 2 <code>decrypt(self, text: bytes)</code> will return the plaintext of a 3DES encrypted ciphertext. But the decrypt <code>key = self.corruption()</code></p>
<p>The corruption function returns an XOR of <code>self.key</code> and a pseudo random generated <code>mask</code></p>
<p><code>flipped_bits</code> is a list of indexes of which bits are flipped. It starts with the last bit (every 8th bit) of each byte flipped.</p>
<p>Lets add </p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#4271ae;">print(</span><span style="color:#718c00;">&quot; &quot;</span><span style="color:#4271ae;">.</span><span style="color:#c82829;">join</span><span style="color:#4271ae;">(</span><span style="color:#8959a8;">f</span><span style="color:#718c00;">&quot;</span><span style="color:#4271ae;">{byte</span><span style="color:#666969;">:08b</span><span style="color:#4271ae;">}</span><span style="color:#718c00;">&quot; </span><span style="color:#8959a8;">for </span><span style="color:#4271ae;">byte </span><span style="color:#8959a8;">in </span><span style="color:#4271ae;">mask))
</span></code></pre>
<p>to print the mask in binary to see what it looks like.</p>
<p>Add this to <code>main</code></p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">for </span><span>i </span><span style="color:#8959a8;">in </span><span style="color:#4271ae;">range(</span><span style="color:#f5871f;">16</span><span style="color:#4271ae;">)</span><span>:
</span><span>    </span><span style="color:#4271ae;">print(i)
</span><span>    </span><span style="color:#4271ae;">chall.</span><span style="color:#c82829;">corruption</span><span style="color:#4271ae;">()
</span></code></pre>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>0
</span><span>01000101 00000011 00000001 00001011 00100011 00000001 01100001 01000001 00101001 00000001 01010001 10010001 00000101 01000101 11001001 10001101 00000001 00000001 10001001 00100001 01000001 01100101 00000001 10000001
</span><span>1
</span><span>11101111 01110111 11110011 10011011 11101111 10011101 11101101 11101101 01111101 01101011 01110101 11011111 01101101 11110101 11111111 10011111 00101001 10010011 11011011 01111011 11110011 11100111 01001101 10011111
</span><span>2
</span><span>11101111 01110111 11111011 10011011 11101111 10011101 11101101 11101101 01111101 01101011 01110101 11011111 01101101 11110101 11111111 10011111 00101001 10010011 11011011 01111011 11111011 11100111 01001101 10011111
</span><span>3
</span><span>11101111 11110111 11111111 11111011 11101111 11011101 11101111 11101111 01111101 11111111 01110111 11111111 01111101 11110101 11111111 10011111 11111101 10011111 11011111 01111111 11111011 11100111 11101101 10111111
</span><span>4
</span><span>11101111 11111111 11111111 11111011 11111111 11111101 11101111 11111111 11111111 11111111 01110111 11111111 11111101 11110111 11111111 11111111 11111101 11011111 11011111 11111111 11111011 11110111 11111101 11111111
</span><span>5
</span><span>11101111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 01110111 11111111 11111111 11111111 11111111 11111111 11111101 11111111 11011111 11111111 11111111 11110111 11111101 11111111
</span><span>6
</span><span>11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 01111111 11111111 11111111 11111111 11111111 11111111 11111101 11111111 11111111 11111111 11111111 11111111 11111111 11111111
</span><span>7
</span><span>11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 01111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111
</span><span>8
</span><span>11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111
</span><span>9
</span><span>10001001 00111001 00000001 01000011 00001001 01000001 00000011 11000001 00000001 00000011 00010101 00010001 00101001 01001101 10000011 10100101 11100011 01000001 10111011 01101111 00001001 00010001 01100101 00001101
</span><span>10
</span><span>10001001 10111011 00000011 01101011 00011011 01001011 00000011 11001111 00011001 00100011 00010101 01010101 00101101 11101101 10000111 10110101 11100011 01011001 10111011 01101111 01001001 11010001 01100111 01111111
</span><span>11
</span><span>10101101 11111111 11000111 11101011 00011011 01001011 11100111 11101111 11111001 00100011 00110101 11111111 10111111 11111101 11110111 10110101 11100011 11111001 10111011 11101111 01011001 11010011 01110111 01111111
</span><span>12
</span><span>11101101 11111111 11000111 11111011 10111111 01001011 11110111 11101111 11111101 11101011 00110101 11111111 10111111 11111111 11110111 11111101 11100011 11111111 10111111 11101111 01011101 11010011 01110111 11111111
</span><span>13
</span><span>11101101 11111111 11010111 11111111 10111111 11101111 11111111 11111111 11111111 11111011 10111101 11111111 11111111 11111111 11111111 11111111 11111011 11111111 10111111 11111111 11011111 11111111 01111111 11111111
</span><span>14
</span><span>11101111 11111111 11111111 11111111 11111111 11101111 11111111 11111111 11111111 11111011 11111101 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111
</span><span>15
</span><span>11101111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111101 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111
</span></code></pre>
<p><code>self.flipped_bits</code> persists between <code>corruption()</code>s. Additional bits are flipped using the previous value until all bits are flipped, and then <code>flipped_bits</code> returns to it's original value.</p>
<pre data-lang="python" style="background-color:#ffffff;color:#4d4d4c;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#8959a8;">if </span><span style="color:#4271ae;">len(</span><span style="color:#c82829;">self</span><span style="color:#4271ae;">.flipped_bits) </span><span style="color:#3e999f;">== </span><span style="color:#f5871f;">192</span><span>:
</span><span>    </span><span style="color:#c82829;">self</span><span>.flipped_bits </span><span style="color:#3e999f;">= </span><span style="color:#c99e00;">set</span><span style="color:#4271ae;">(range(</span><span style="color:#f5871f;">0</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">192</span><span style="color:#4271ae;">, </span><span style="color:#f5871f;">8</span><span style="color:#4271ae;">))
</span></code></pre>
<p>Given enough iterations (can be seen at i=8) <code>mask</code> always becomes</p>
<p>11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111 11111111</p>
<p>This means the <code>decrypt()</code> function should inevitibly use the compliment of <code>self.key</code></p>
<p><a href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES exhibits the complementation property, namely that</a></p>
<p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/e567b0f71aff5efa778ec2660f1ef7c5b0f04ba7" alt="alt text" /></p>
<p>DES being symmetric, the complementation property applies to decrypting as well.</p>
<p>Taking the complement of ciphertext from <code>get_challenge()</code>, and <code>decrypt()</code> it when the key is in the complement state, I should get the complement of <code>challenge</code>.</p>
<p>The first 8 bytes will need to be complemented again, because in <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">CBC mode</a></p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/CBC_decryption.svg/512px-CBC_decryption.svg.png" alt="alt text" /></p>
<p>The first block is XORed with IV, subsequent blocks are XORed with the previous block's ciphertext.</p>
<p>So when you decrypt with the all-bits-flipped key, the intermediate result before XORing with the IV is the complement of what it should be. Since the IV remains the same, you need to complement the result to get the correct first block.</p>
<p>For subsequent blocks, the XOR with the previous ciphertext block (which wasn't affected by the key corruption) naturally corrects this complementation effect.</p>
<p><code>get_flag()</code> will <code>sys.exit(0)</code> and I'll get <code>Not quite right</code>, which will reset <code>challenge</code>. Let's keep trying the 8th <code>decrypt()</code> until it works.</p>
<h2 id="solve">Solve</h2>
<p>Get challenge ciphertext</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>1
</span><span>d7fb309d5a3ac2f3e916c73957d110a3d546491bfd75ccec6eb544347185cbad5dfd58e72e2eed02b2ccbe260ad572497f21d9bd44069c1234ae4e5e5f10d2e2
</span></code></pre>
<p>Compute the complement cipher text <code>2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d</code></p>
<p><img src="/images/googlectf-2024-desfunctional-writeup-1.png" alt="alt text" /></p>
<p>Decrypt until lucky</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>33688802886637db3b0f8dd997c8fd0be42a3ce44205f326fc0456e0c1654f1162fba220266a91a1930e61aeffb3ce93a4f5fa58af893c8c3c58ef4574fd86d8
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>3bbd1f34a492ff8fb1370369d19d40f62803a0fb64ebc7427426bb335cfca606b7138afed101135c069656dd053151876867aab9712ab7ab82c7e8b573f6f58a
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>5d98dfa2b47e298a65805ca7c478246ff23b44071e2a00431b82610254e9dc09bdc919cb766a8ac9a93b179f8203214b57b2b6947d81adec1e34a0ccdc2d9030
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>79910b8da4ab535386ae5fa75535b34aae174a1ab37e8c7469c25e609ffca7fbe013796e95552bd389e38d3c89ef92718814e681948fc0b54ef819d30467d4dd
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>e284a92a0dae7a43e5911c2c7994e859bab57d7012bf443766fb03516daad0c44757b89040ac56736bf6697c24c2e9be2b6850d87c5b4d0d734e14ebb3361afd
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>fec5bcd64752cb713bb8dea376d67ab0dc9948137b94a503e9ea9701bab73b46764ee442b63260294bc862326e23ea4408037511edc6db77a367af59659f626b
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>7ff31c047fd84d0b47706b119bf9398aa595138ef523428db8282cb70afca61742a75d04d800f7b6eb068cf15f61a6f83f16680b68f563bb73f5e7c7910e6b40
</span><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>2
</span><span>(hex) ct: 2804cf62a5c53d0c16e938c6a82eef5c2ab9b6e4028a3313914abbcb8e7a3452a202a718d1d112fd4d3341d9f52a8db680de2642bbf963edcb51b1a1a0ef2d1d
</span><span>4058ca05a13a4c9f00c989e10b3d9ed1e68af5dd26cd90dcaaeb7db69f6582b195a3ea8272e2d523cfb2c5d2bd1830923eefc25f2444e708c64ab8cd249115fc
</span></code></pre>
<p>Compute the complement of the first 8 bits <code>bfa735fa5ec5b360</code></p>
<p><img src="/images/googlectf-2024-desfunctional-writeup-2.png" alt="alt text" /></p>
<p>Use it to form challenge <code>bfa735fa5ec5b36000c989e10b3d9ed1e68af5dd26cd90dcaaeb7db69f6582b195a3ea8272e2d523cfb2c5d2bd1830923eefc25f2444e708c64ab8cd249115fc</code></p>
<p>Get the flag</p>
<pre style="background-color:#ffffff;color:#4d4d4c;"><code><span>Choose an API option
</span><span>1. Get challenge
</span><span>2. Decrypt
</span><span>3. Get the flag
</span><span>3
</span><span>(hex) pt: bfa735fa5ec5b36000c989e10b3d9ed1e68af5dd26cd90dcaaeb7db69f6582b195a3ea8272e2d523cfb2c5d2bd1830923eefc25f2444e708c64ab8cd249115fc
</span><span>CTF{y0u_m4y_NOT_g3t_th3_k3y_but_y0u_m4y_NOT_g3t_th3_c1ph3rt3xt_as_w3ll}
</span></code></pre>


    </div>
  </section>
</body>

</html>